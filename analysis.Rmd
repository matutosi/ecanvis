---
title: "植生調査資料の解析"
author: "松村 俊和"
date: "2025-11-21"
institute: "甲南女子大学"
output:
  # https://github.com/rstudio/revealjs
  revealjs::revealjs_presentation:
    self_contatined: false
    theme: simple
    transition: convex
    css: style.css
    reveal_options:
      slideNumber: true
---

```{r, echo = FALSE, eval = FALSE}
  # rmarkdown::render("D:/matu/work/todo/ecanvis/analysis.Rmd")
  # 
  # https://matutosi.github.io/ecanvis/analysis.html
  # https://matutosi.github.io/ecanvis/analysis.html?print-pdf # PDF印刷用
```

```{r setup, include = FALSE}
pkg <- "tidyverse"; if(!require(pkg, character.only = TRUE)) install.packages(pkg)
pkg <- "knitr"    ; if(!require(pkg, character.only = TRUE)) install.packages(pkg)
pkg <- "flextable"; if(!require(pkg, character.only = TRUE)) install.packages(pkg)
pkg <- "magrittr" ; if(!require(pkg, character.only = TRUE)) install.packages(pkg)
pkg <- "ecan"     ; if(!require(pkg, character.only = TRUE)) install.packages(pkg)
pkg <- "vegan"    ; if(!require(pkg, character.only = TRUE)) install.packages(pkg) # ecanと同時にインストールされる
pkg <- "ggdendro" ; if(!require(pkg, character.only = TRUE)) install.packages(pkg) # 図示で使用
pkg <- "ggrepel"  ; if(!require(pkg, character.only = TRUE)) install.packages(pkg) # 図示で使用

knitr::opts_chunk$set( # 警告, メッセージ, エラーの非表示
  warning = FALSE,
  message = FALSE,
  error   = FALSE)

  # Generate table
gen_table <- function(tbl, caption, caption_tex = caption){
  if(knitr::is_latex_output()){
    table <-   # pdf
      tbl |> 
      knitr::kable(format = "latex", booktabs = TRUE, caption = caption_tex)
  }else{
    table <-   # HTML, word
      tbl |>
      flextable::flextable() |>
      flextable::theme_vanilla() |>
      flextable::set_table_properties(align = "left", layout = "autofit") |>
      flextable::set_caption(caption)
  }
  table
}
  # Helper for gen_table()
str2tbl <- function(str, ncol){
  tbl <- matrix(str, ncol = ncol , byrow = TRUE)
  tbl |>
    magrittr::set_colnames(tbl[1,]) |>
    `[`(_, -1, ) |>
    tibble::as_tibble()
}
  # memo：他のオプション
  #                   コード表示  結果  実行
  # eval = FALSE    #     ◯      －    －
  # echo = FALSE    #     －      ◯    ◯
  # include = FALSE #     －      －    ◯
```

# 解説の内容

- 基礎的・一般的な手法を紹介
  - 他にも色々とある
  - 書籍や論文で学ぶ
- 生成AIに質問すれば教えてくれる
  - 基本的な考え方の理解が重要
  - ブラックボックスではダメ

<aside class="notes">
植生学では現地調査によって収集した調査資料を解析することで，植物群集の特徴などを明らかにします．
解析手法には，種多様性指数のような基礎的なものから，種の分布の予測のような応用的なものまで多種多様なものがあります．
各手法の詳細は，専門の書籍や論文によって定義や使い方を学んでください．
本稿では，基礎的かつ一般的な手法を紹介します．
なお，植物社会学的調査方法による表操作は本稿での対象外です．

生成AIに質問すれば色々と教えてくれます．
たとえば，生成AIに調査資料をアップロードして「各地点の種多様性を計算してください」質問するとします．
種数だけでなくShannonのH'やSimpsonの1/dなど多様性指数も回答してくれるかもしれません．
ただし，多様性指数が何を意味するのかの基本的な考え方が理解できなければ，回答を得ても意味がありません．
多様性指数を実際に計算をできなくても構いませんが，全くのブラックボックスではダメです．
</aside>

## 全体像

- 調査資料の取り扱い
- 解析手法の種類
  - 多様性指数
  - クラスター分析
  - 序列化
  - 指標種分析
- 演習編
  - 準備
  - 前処理
  - 解析・図化

<aside class="notes">
まず，調査資料の取り扱い方を説明します．
その後，基本的な解析手法として，多様性指数，クラスター分析，序列化，指標種分析を紹介します．
ここでは，基本的な考え方を中心に説明します．
その後，具体的な調査資料をもとにした演習をします．

Rを使用しますので，事前にインストールしておいてください．
インストール方法は，ネットで検索すれば出てきます．
また，使用するパッケージもインストールする必要があります．
</aside>


# 調査資料の取り扱い

- Tidyな形式で保存
- パソコンへの入力方法
- データの変換

<aside class="notes">
調査資料をパソコンに保存するときに重要なことは，Tidyな形式で保存することです．
人間が理解しやすい植生調査表のような形式は，パソコンには理解しづらいためです．
また，植生調査に関する資料では，地点, 組成, 種と全く異なる形式のものがあり，これらは別々に保存します．
詳細は別途説明します．
場合によっては被度のような量的データを変換する必要があります．
</aside>

## Tidyとは

- Hadley (2014)
- 整然とした状態：データ解析では必須
  - 1つの変数が1つの列
  - 1つの観測が1つの行
  - 1つのタイプの観測群が1つの表
  - 1つの値が1つのセル

<aside class="notes">
Tidyとは，整然としたという意味で，データがパソコンが理解しやすい状態に整理されていることを意味します．
詳細は，Hadley(2014)をご覧ください．

言葉だけみてもわかりにくいので，Excelなどのスプレッドシートに地点情報を入力するとします．
1つの変数が1つの列とは，A列に地点名が，B列に調査日をそれぞれ入力した状態です．
1つの観測が1つの行とは，2行目に1地点目の情報である地点名，調査日，緯度，軽度などを入力した状態です．
なお，1行目には項目名を入力するのが一般的です．
1つのタイプの観測群が1つの表とは，地点情報と組成の情報を別々のシートに入力した状態です．
1つの値が1つのセルとは，A2のセルには1つの値のみが入っている状態です．

</aside>

## Tidy vs Messy

"Happy families are all alike; <br>
every unhappy family is unhappy in its own way."<br>
— Leo Tolstoy

"Tidy datasets are all alike, <br>
but every messy dataset is messy in its own way."<br>
— Hadley Wickham

<aside class="notes">
トルストイの小説『アンナ・カレーニナ』の冒頭に"Happy families are all alike; every unhappy family is unhappy in its own way."という言葉があります．
データも同じで，Hadley Wickham氏は"Tidy datasets are all alike, but every messy dataset is messy in its own way."と述べています．
</aside>

## Messy data

```{r messy}
tidyr::table2
```

<aside class="notes">
これはmessyデータの例です．
このデータは結核症例数を示したものです．
type列にcases(罹患数)とpopulation(人口)という2つの項目があり，その数値がcount列にある点でtidyではありません．
本来は，casesとpopulationは項目名であり，それぞれが別の列に配置されるべきです．
</aside>

## Tidy data

```{r tidy}
tidyr::table2 |>
  tidyr::pivot_wider(
    c(country, year), 
    names_from = type, 
    values_from = count)
```

<aside class="notes">
これはtable2のデータを`tidyr::pivot_wider()`でtidyに整理したものです．
</aside>

## 植生データの種類

- 地点：地点, 緯度, 経度, 標高, 日時, ...
- 組成：地点, 階層, 種名, 被度, ...
- 種：種名, 科, 生活型, 機能型, ...

<aside class="notes">
地点データには, このほかに地形, 天候などもあります．
組成データには, このほかに植物の状態(実生, 開花の有無)などもあります．
種データには, このほかに系統関係などもあります．
</aside>

## パソコンへの入力

- 1行目は項目名
- 空の行，空の列，空のセルはつくらない
- テキストファイル(CSV or TSV)で保存(推奨)
  - 誤変換を防ぐ
  - 再利用が容易
- スプレッドシートでの保存
  - 組成, 地点, 種を別シートに入力
  - 文字列として保存(誤変換対策)

<aside class="notes">
調査資料を解析するときには，パソコンにデータを入力します．
入力には，Excel等のスプレッドシートを使うのが楽です．
ただし，入力時の注意点が主に3つあります．
1つ目は，シートの1行目には項目名を入力することです．
2つ目は，空の行，空の列，空のセルはつくらないことです．
特に，見やすさを考慮して1行目や1列目を空けたりするかもしれませんが，これは不要です．
空けないようにしてください．
また，欠損値を空のセルにしたりするかもしれません．
空のセルは，後から見たときに欠損値か入力漏れか判別できません．
欠損値の場合は，"NA"あるいは"-"のような文字列を入力してください．
使用する文字列は任意ですが，実際のデータに含まれないものを使います．
3つ目は，保存するときはCSV(Comma Separated Values，カンマ区切りのテキストファイル)あるいはTSV(Tab Separated Values，タブ区切りのテキストファイル)で保存することを推奨します．
CSVやTSVで保存したデータは，保存・読み込み時に誤変換が起こりにくいです．
文字コードは，UTF-8が一般的です．
また，CSVやTSVはOSによらず読み込み可能ですので，再利用が容易です．

スプレッドシートで保存する際には，組成, 地点, 種を別シートに入力してください．
また，セルの書式を文字列にしておくと，誤変換しにくいでしょう．
</aside>

## データ変換

- Braun-Blanquetの階級値
- 百分率
- 在・不在
- 平方根
- 対数

<aside class="notes">
植生学では，どの地点に，どの種が，どの程度の量で生育していたのかを記録します．
地点や種は名義尺度ですので，そのまま記録します．
どの程度の量生育していたかは，量の測定と記録方法は多くの方法があります．
個体数を記録することもあれば，被度を記録することもあります．
ここでは，被度を記録するとします．
植物社会学では，被度をブラウン・ブランケの階級値を使うことが多いでしょう．
また，被度を百分率で記録することや有無のみを記録することもあります．
百分率のままでは差が大きすぎるときに，平方根や対数によってばらつきを小さくすることができます．

取得したデータを解析のために変換することもあります．
たとえば，階級の中央値への変換や，平方根や対数での変換です．

なお，優占度はここでは扱いません．
もちろん，未同定種や種の分類の問題はありますが．

その他，鈴木(1954)のp61，星野(1991)，小林(1995)のp53,54も参考になります．

03479.pdf
</aside>

## データ変換

```{r convert-value}
bb_scale <- c("5", "4", "3", "2", "1", "+", "r", "0")
percentage <- c(75, 50, 25, 10, 1, 0.1, 0.01, 0) # 百分率
percen_med <- (percentage + lag(percentage, default = 100)) / 2
percen_med[length(percen_med)] <- 0
pa <- purrr::map_dbl(percentage > 0, sum)
squared <- percentage^0.5
logged <- log10(percentage + 1) # +1: 1未満を正にするため
tibble::tibble(bb_scale, percentage, percen_med, pa, squared, logged)
```

## 相対優占度

- 定義
  - nij：地点jでの種iの量(被度や個体数)
  - Nj：地点jの全種の量の合計<br>
  Nj = Σnij
  - Pij：地点jでの種iの相対優占度<br>
  Pij = nij / Nj

```{r propotion}
val <- c(4, 3, 2, 1)
val / sum(val)
```

<aside class="notes">
単純なデータ変換ではなく，相対値を求める変換として相対優占度の算出があります．
相対優占度とは，ある地点における出現種の量(被度や個体数)の相対値で，全出現種の優占度の合計で各出現種の優占度を割ったものです．

ある地点に種aからdまでの4種が生息していたとして，優占度がそれぞれ4,3,2,1であったとします．
合計は10ですので，それぞれの相対優占度は0.4, 0.3, 0.2, 0.1です．
相対値に変換することで，地点ごとの優占度のばらつきを取り除きます．

なお，相対優占度は，多様性指数の計算や類似度の計算で利用します．
</aside>

## Hellinger変換

- 相対優占度の平方根

```{r propotion-square}
val <- c(4, 3, 2, 1)
proportion <- val / sum(val)
proportion ^ 0.5
```

<aside class="notes">
相対優占度を算出した後で平方根を取ることをHellinger変換といいます．
相対優占度によって地点間のばらつきを取り除き，Hellinger変換によって地点内のばらつきを小さくします．
Hellinger変換は，後述するクラスター分析で使用します．
</aside>

# 解析の種類

- 多様性指数：α, β, γ
- 分類：クラスター分析<br>
  TwinSpan, 分類回帰樹木, ...
- 序列化(Ordination)：PCA, PCoA, DCA, nMDS,<br>
  CCA, RDA, ...
- 指標種分析(ISA：Indicator Species Analsis)
- その他
  - Rarefaction Curve
  - 時系列分析
  - 分布モデル
  - ...

<aside class="notes">
植生調査試料の解析手法は多種多様です．
基本的な手法には，多様性指数の算出から，クラスター分析などを用いた分類，序列化，指標種分析があります．
Rarefaction Curve，時系列分析，分布モデルなどもあります．
目的によって解析手法は異なりますので，自分の研究でしたいことにあった手法を使ってください．
まずは書籍や論文を読んでどのような手法があるのか学んでください．

目的が明確にできているのなら，それをもとに生成AIに相談しても良いかもしれません．
ただし，基本的な考え方については理解することと，研究者自身の最終的な判断することが必要です．
</aside>

# 多様性指数

- α：地点内の多様性<br>
  - 1地点あたりの種数
  - 均等度の考慮の有無
- β：地点間の多様性(類似度)
  - β = γ / α
  - β = γ - α
- γ：地域内の多様性
- 地点・地域の大きさは任意

<aside class="notes">
多様性指数は，生物群集の豊かさを数値化したものです．
種数だけでなく均等度を考慮した指数があります．

生物群集の豊かさは，空間規模が大きくなるほど豊かになります．
そのため，豊かさの表現や比較には空間規模の設定が必要です．
一般的には，空間規模に応じた多様性として，地点内の多様性をα多様性，地点間の多様性をβ多様性，地域内の多様性をγ多様性の3つが使われるます．

α多様性の地点とγ多様性の地域の大きさは任意です．
α多様性の地点としては1つの調査地点を用いて，森林ならば100-400㎡などの規模，草原ならば1-10㎡が使われることが多いです．
γ多様性の地域としては幅が広く，複数個の調査地点，景観規模，市町村単位までの規模が使われます．
β多様性は地点間の多様性であり，γ多様性とα多様性との比率と定義するときと，γ多様性とα多様性との差として定義することがあります．

さらに，地点，地点の複数の集まり，複数の地点の集まりの景観規模，景観規模の集まりの市町村単位，市町村の集まりのの都道府県単位のように入れ子状に考えることもありますWagner(2000)．
</aside>

## α多様性

- 主な指数
  - 種数：S
- Simpsonの均等度
  - d =  Σ(Pij)^2
  - 1 - d：均等度のみ考慮
  - 1 / d：均等度と種数を考慮
- Shannonの情報量：H'
  - H' = -Σ(Pij・ln(Pij))

<aside class="notes">
α多様性の代表的な指数として，種数(S)，Simpsonの均等度指数，Shannonの情報量指数があります．
Sはある地点に出現する種数です．
Simpsonの指数は，本来は集中度指数としてdがあります．
集中度と均等度は反対の概念ですので，その逆数である1/d，1との差である1-dが均等度指数として使われます．

均等度指数では，まず相対優占度を算出します．
各出現種の相対優占度を二乗したものを，合計したものがSimpsonの集中度指数dです．
1つの種に優占度が集中したとき，つまり出現種が1種のときに最大値である1になります．
集中度が低い，つまり多くの種が出現するとき，優占度が出現種で均等であるときは，小さくなります．
全ての種が均等に出現するときには，dは1/Sと等しい値になります．

1 / dは，dの逆数です．
出現種が1種のときに最小値である1で，全ての種が均等であるときには種数であるSと同じです．
1 - Dは，最小値が0で均等であるほど大きくなります．

Shannonの情報量指数は，各種の相対優占度に相対優占度の対数を乗じたものを合計します．
対数の底はe，つまり自然対数を使うことが多いですが，底に2を使うこともあります．
他の研究とH'を比較するときには，対数の底を確認してください．

なお，α多様性と同じ方法でγ多様性も算出します．
</aside>

## Simpsonの均等度指数

```{r d-inv-1}
val <- rep(0.2, 5) # 5種とも全て0.2のとき
nj <- sum(val)     # 出現量の合計
pi <- val / nj     # 相対優占度
d <- sum(pi^2)
c(d, 1/d)
```

<aside class="notes">
Simpsonの均等度指数を実際に計算します．
簡単な内容ですので，手入力でRで実行してみましょう．

5種全てが均等な場合です．
わかりやすくするために，合計の量が1になるようにしています．
dが0.2で，1/dが種数と同じ5です．
</aside>

## Simpsonの均等度指数

```{r d-inv-2}
val <- c(0.6, 0.1, 0.1, 0.1, 0.1) # 1種が0.6,他が0.1
nj <- sum(val)     # 出現量の合計
pi <- val / nj     # 相対優占度
d <- sum(pi^2)
c(d, 1/d)
```

<aside class="notes">
1種が半分以上の量を占めている場合です．
dが0.4で，1/dが2.5です．
特定の種が優占しているため，多様性指数が低くなりました．
</aside>

## α多様性の個人的見解

- 基本情報としての種数
- 均等度と種数を考慮：1/dが理解しやすい
  - 最小値：1
  - 最大値：S(全種が均等)
- 均等度のみ：1 - d

<aside class="notes">
α多様性のまとめです．
種数は基本的な情報として重要です．
種数と均等度の両方を考慮した多様性指数は，1/dが理解しやすいです．
最長値が1で，最大値が出現種数と同じになるためです．
均等度のみを考慮した指数としては，最小値が0で最大値が1になる1-dがよいでしょう．
</aside>

## β多様性・γ多様性

- β多様性は γ / α または γ - α
  - 一般的にはγ / α
  - 比較の際には定義の確認が必要
- γ多様性の算出方法はα多様性と同様

<aside class="notes">
β多様性は，γ多様性とα多様性の比もしくは差として定義されます．
多くは比を用いていますが，差を用いている場合があります．
そのため，β多様性を比較する際には，定義およびα多様性とγ多様性を求めている空間規模の確認してください．
なお，γ多様性の算出方法はα多様性と同様です．
</aside>

# クラスター分析

- 概要
  - 地点あるいは種を分類
  - 地点の分類：種の出現の仕方(類似度)を算出
  - 方法
    - 地点(種)間の類似度を計算
    - 「近いもの」を結合
  - 類似度と結合方法によって結果が異なる
  - グループ内での順序は無意味

<aside class="notes">
クラスター分析は，地点あるいは種をその出現の仕方に基づいて，クラスターというまとまりに結合していき，地点あるいは種を分類する手法です．
生態学では，地点を分類することが多いです．
地点を分類するときには，地点間の種の出現の仕方，つまり類似度を計算します．
類似度の計算方法には多くの手法があります．
類似度をもとにして「近いもの」を結合していきます．
結合方法にも多くの手法があります．
類似度と結合方法としてどれを使うかによって，結果として得られるクラスターが異なります．
また，グループ内での順序の並びは無意味です．
</aside>

## 類似度

- ユークリッド距離<br>
  ((x1-x2)^2 + (y1-y2)^2)^0.5
- Hellinger距離<br>
  Hellinger変換してからユークリッド距離を計算
- マンハッタン距離(碁盤の目の移動)<br>
  |x1-x2| + |y1-y2|
- Bray-Curtis距離：マンハッタン距離を標準化<br>
  |x1-x2| / (x1+x2) + |y1-y2| / (y1+y2)

<aside class="notes">
類似度は，各地点での種の出現量をもとに計算します．
ユークリッド距離は，点の間の直線距離です．
Hellinger距離は，相対優占度の平方根を取るHellinger変換したもののユークリッド距離を計算したものです．
マンハッタン距離は，碁盤の目の移動距離です．
Bray-Curtis距離は，マンハッタン距離を標準化したものです．
標準化とは，出現量で割ることで標本の大きさの影響をなくすことです．

このうち，ユークリッド距離，Hellinger距離，マンハッタン距離はメトリックであり，Bray-Curtis距離は半メトリックであるといわれます．
メトリックであるためには，非負性，同一律，対称性，三角不等式の4つの条件を満たす必要があります．
非負性とは，距離は必ず0以上であることです．
同一律とは，全く同じ点間の距離は0であることです．
対称性とは，距離abと距離baは等しいことです．
三角不等式とは，aからbへの距離は、任意の第3の点cを経由した距離の和より小さいか等しい，つまり遠回りをする方が近道よりも短くなることはないことです．

Bray-Curtis距離では標準化の影響によって三角不等式を満たさない場合があるためです．
三角不等式を満たすとは，aからbへの距離が，任意の第3の点cを経由した距離の和より小さいことで，遠回りをする方が近道よりも短くなることはないということです．
Bray-Curtis距離では，論理的には三角不等式を満たさないことがあるため，半メトリックな指標とされます．

メトリックな距離とそうでない距離では，クラスター分析や序列化で使える手法が異なります．

なお，SorensenのQS(Quotient of Similarity)は，出現量を在・不在データに変換したものと同じです．

小林(1995)のp26
</aside>


## 主な結合方法

- 最近隣法
- 非加重群平均法(UPGMA)
- Ward法

<aside class="notes">
説明でよく使われる結合方法として最近隣法があります．
グループの結合後も，グループ間で最も近い地点のあるグループを結びつけます．
一度だけ類似度を計算すれば良いので，計算量が少ないという利点があります．
グループ結合後に，鎖状あるいは帯状に細長くつながってしまう減少が起こりやすいという欠点があります．

非加重群平均法(UPGMA)は，グループ結合後にグループ間の距離を再計算します．
計算量は多くなるものの，よほど多くの地点でない限り問題になることはほとんどありません．
UPGMAで用いる距離は，メトリックな指標でなくても構いません．

Ward法はクラスター内での分散が小さくなるようにグループを結合します．
分類感度がよく，外れ値の影響を受けにくいとされます．
Ward法で用いる距離は，メトリックな指標であることが必要です．


https://iit.kke.co.jp/marketingscience/analysis/method/analysis_cluster.html
</aside>

## クラスター分析の個人的見解

- 地点や種を結合
- 1次元的
- 一般的な組み合わせ
  - Bray-Curtis距離 + 非荷重群平均法
  - Hellinger距離 + Ward法 ("ward.D2")

<aside class="notes">
クラスター分析のまとめです．
ただし，あくまでも個人的見解です．
クラスター分析は，似たような地点や種を結合する手法です．
結合したものは，類似度のみが意味を持ち，グループ内での順序の並びは無意味です．

結局どの組み合わせを使えば良いのかですが，手法として妥当かつよく使われる組み合わせは2つあります．
Bray-Curtis距離をもとに非荷重群平均法で結合する方法と，Hellinger距離をもとにWard法で結合する方法です．



Bray-Curtis距離はマンハッタン距離の標準化であるため，生態学的な意味が理解しやすいです．
ただし，Bray-Curtis距離は厳密にはメトリックではないので，
分類感度がよく，外れ値の影響を受けにくいとされるWard法が使えません．
そのため，メトリック距離ではなくても良い非荷重群平均法が使われます．

メトリックなHellinger距離をもとにしたWard法もよく使われます．
なお，veganやecanの関数の引数では，"ward"ではなく"ward.D2"を使います．
</aside>

# 序列化, Ordination

- 手法は多種多様
  - PCA：主成分分析
  - DCA：除歪対応分析
  - PCoA：主座標分析
  - nMDS：非計量多次元尺度法
  - CCA：正準相関分析<br>
    長い環境軽傾度との対応
  - RDA：冗長性分析<br>
    短い環境軽傾度との対応
- 類似度との組み合わせで結果が異なる

<aside class="notes">
序列化の手法は，Ordinationとも言われます．

その方法は本当に色々とあります．
PCA(主成分分析)自体を使うことはほとんどありませんが，基本的な考え方ですので，最初に説明します．
DCAは場合によって使われることがあります．
PCoAとnMDSは比較的よく用いられます．

環境軽傾度との対応関係を明らかにする手法としてCCAとRDAがあり，それぞれ長い環境軽度と短い環境軽度のときに用いられます．

クラスター分析と同様に，類似度との組み合わせで結果がことなります．
また，手法によっては使える距離に制限があります．

詳しくは，佐々木ほか(2015)のp30を参考にしてください．
</aside>

## PCA：主成分分析

- Principal Component Analysis
- 次元削減
  - 多変量から相関のない成分で説明
  - 一般的には第1軸と第2軸でほぼ説明
- 馬蹄(アーチ)効果

<aside class="notes">
主成分分析は，PCAとよばれることが多い手法で，序列化としてまず説明される手法です．
序列化とは，多変量のデータの次元を削減する手法です．
例えば，50地点の植生調査資料に全体で100種が出現したとします．
地点をもとに考えると，種数と同じ数だけつまり100次元の空間が考えられます．
人間はそもそも，100次元のデータを理解することは困難ですので，この中から重要な成分を取り出そうというのが次元削減です．

100次元のものを次元削減しても，多くの成分が出てきます．
ただし，一般的には第1軸と第2軸でほぼすべてを説明できます．
使用するとしても，実際には第4軸ぐらいまでです．

PCAはその手法の結果として馬蹄効果が現れることがあります．
これは別途説明します．

説明を簡単にするために，xとyの2次元で考えます．
この配置を説明するのに最も良い次元はxでもyでもなく，

</aside>


```{r}
set.seed(14)
n <- 10
x <- 1:n
y <- x * 2 + rnorm(n) * 2
df <- tibble::tibble(x = x, y = y) 
ggplot2::ggplot(df, ggplot2::aes(x, y)) + ggplot2::geom_point()
lm(df)
```

## 馬蹄(アーチ)効果

- 長い環境軽度
- アーチ状に配置
- 入れ替わりが一定のデータ
  - 類似度だけなら，直線上にならぶはず
  - 類似度が低いはずの地点が近くに配置される

<aside>
馬蹄効果とは，種の入れ替わりのある長い環境軽度のデータを序列化によって配置したときに，馬蹄(馬のひづめ)形，つまりアーチ状になってしまうことです．
もし，入れ替わりが一定のデータがあったときに，類似度だけを考えるなら直線上に配置されるはずです．
しかし，PCAの第1軸と第2軸で実際に配置すると，全体の配置が馬蹄形になります．
その結果，類似度が低いはずの地点が近くに配置されてしまいます．
これは，PAC以外の他の手法でも現れることがあります．
出現のない地点が多いときに現れやすく，植生データではこのようなことはよく起こります．
しかし，これを直接克服することはできません．
</aside>


## DCA：除歪対応分析

- Dtrended Component Analysis
- 植生以外ではあまり使われない

<aside class="notes">
PCAの馬蹄効果を除去するために考えられたのが，DCAです．
ただし，植生学以外ではほとんど用いられることはありません．

DCAでは馬蹄効果を強制的に除去します．
第1軸で出現した馬蹄効果を除去するために，まずは第1軸上で区間を区切ります．
各区間での第2軸の平均地を求めて，各区間の平均が等しくなるように第2軸の数値を計算します．

区間の区切り方は恣意的なもので，その区切り方によって結果が大きく異なります．
つまり，かなり恣意的な再配置ですので批判が多くあります．
そのため，あまり用いられなくなっています．

ただし，植生学をはじめとする生態学では多くの手法が生み出されたという歴史的な経緯を知っておいて損はありません．
</aside>

## PCoA：主座標分析

- Principal
- 
- 

<aside class="notes">

</aside>


## nMDS

- non-Demensional Multiple 
- 非計量多次元尺度法

<aside class="notes">

</aside>

## CCA

- 正準相関分析

<aside class="notes">
生態学における序列化手法は、データの特性と解析の目的に合わせて進化してきました。初期の段階では、ユークリッド距離に基づく線形モデル（PCA、RDA）が中心でしたが、生態学データの非線形性、特に長勾配の普遍性が認識されるにつれて、非ユークリッド距離に基づく手法が主流となりました。
現在、群集構造の全体像を把握し、ベータ多様性を測定する非制約型解析では、生態学的妥当性の高いBray-Curtis距離  を入力としたPCoAまたはNMDSが標準的な選択肢となっています。PCoAは、この非ユークリッド距離を計量的に表現する力を持ち、NMDSはその順序関係に対する堅牢性で優れています。一方、環境要因との関連をモデル化する制約型解析では、線形応答の仮定が成立する場合はRDAが、ユニモーダル応答の仮定が成立する場合、すなわち長勾配データにはカイ二乗距離  を基盤とするCCAが適用されます。
</aside>

## RDA

- 冗長性分析

## 序列化の個人的見解

- 2次元座標への配置<br>
  本当は多次元だが, 実質的には2次元が多い
- Bray-Curtis距離 + PCoA or nMDS

<aside class="notes">
序列化は，主要な成分として多次元への配置をするものです．


実際によく使われる序列化手法は，Bray-Curtis距離をもとにしたPCoAとBray-Curtis距離をもとにしたnMDSです．

環境軽度との関係を分析する場合は，CCAかRDAを使います．
環境軽度が長いときはCCAを，短いときにはRDAを使うことが多いです．
ただし，これは相対的なものですので，まずは両方を試して考えても良いかもしれません．
</aside>

# 指標種分析

- 特定のグループに特徴的に出現する種を抽出
- 在・不在，量のどちらでも可能
- Dufrene and Legendre (1997)

<aside class="notes">
指標種分析は，グループ分けした地点に特徴的に出現する種を明らかにするものです．
出現の有無を使うこともできますし，量を使うことも可能です．
また，繰り返し計算による無作為化検定が可能です．

詳細は，Dufrene and Legendre (1997)をご覧ください．
</aside>

## 指標値の計算

- IV = Cij / Ci * Fij/ Fj * 100
  - Cij：種iのグループjでの平均被度
  - Ci：種iの全体での平均被度
  - Fij：種iのグループjでの出現回数
  - Fj：種iの全体での出現回数

<aside class="notes">
</aside>

# データ分析の実演

- パッケージの準備
- veganパッケージのデータ
- 前処理：かなり重要
- α多様性
- クラスター分析
- 序列化
- 指標種分析

<aside class="notes">
ここからは実際にデータ分析をします．
準備としてRをインストールしてください．
また，植生解析のためのパッケージであるvean等のパッケージもインストールしてください．

本来は自身のデータを使うのが一番良いのですが，ここではveganに含まれるデータを使用します．
veganのデータもそうですが，すべてのデータがtidyであるとは限りません．
前処理がデータ分析の8割を占めると言われることもあるように，前処理はかなり重要です．
分析の前に前処理を少しします．

その後実際のデータ分析としてα多様性の計算，クラスター分析，序列化，指標種分析を実行します．
Rのコードは次に示すところから入手可能です．
また，それぞれの分析手法のすべてを実行するわけではありません．
細かな点は，関数の引数を変更すれば実行可能なことが多いです．
場合によっては，事前のデータ変換が必要です．
</aside>

## 参考URL

- https://matutosi.github.io/ecan/ とほぼ同じ内容
- https://matutosi.shinyapps.io/ecanvis/ でも実行可能

<aside class="notes">
実行する内容は，githubのecanの解説ページとほぼ同じです．
shinyを使ったページでも同じようなことを実行可能です．

それぞれ参考にしてください．
</aside>

# 準備：パッケージのインストール

- tidyverse: コードを明快に
- vegan: 植生データ解析の定番
- ecan: 各種関数を簡単に実行

```{r install-packages, eval = FALSE}
install.packages("tidyverse")
install.packages("ecan")
install.packages("vegan")    # ecanと同時にインストールされる
install.packages("ggdendro") # 図示で使用
install.packages("ggrepel")  # 図示で使用
```

<aside class="notes">
各種パッケージを事前にインストールしてください．
このコードは，1回だけ実行すれば構いません．

tidyverseは，コードを明快にするためのものです．
tidyverseは，tibble，tidyr，dplyr，purrr，ggplot2などのパッケージを含むパッケージ群です．

植生解析以外のコードを書くときに役立ちます．
veganは，植生データ解析の定番パッケージです．
ecanをインストールするときに同時にインストールされます．
もちろん，個別にインストールしても構いません．

クラスター分析や序列化は，手法が多くあります．
それぞれの手法が複数のパッケージにまたがっています．
パッケージごとに引数の指定の仕方が異なっています．
また，返り値の仕様もバラバラです．

バラバラの引数や返り値を使いやすくするためにecanというパッケージをまとめました．
いわばパッケージのラッパーのパッケージです．

これらの他に，ggdendroとggrepelというパッケージを図示で使用しますので，インストールしてください．
</aside>

## 準備：パッケージの呼び出し

```{r, include = FALSE}
library(vegan)
library(ecan)
library(tibble)
library(tidyr)
library(dplyr)
library(purrr)
library(ggplot2)
library(ggdendro)
library(ggrepel)
```

```{r load-library, eval = FALSE}
library(vegan)
library(ecan)
library(tidyverse)
library(ggdendro)
library(ggrepel)
```

<aside class="notes">
パッケージを呼び出しておきます．
コード中ではパッケージ名をできるだけ明示しています．
たとえば，`dplyr::select()`はdplyrパッケージの`select()`という関数です．
ただし，`library()`でパッケージを呼び出しておけば，パッケージ名の明示は不要です．
</aside>

# 基本データの準備(演習)



## dune.envデータ(地点)

```{r dune-env}
data(dune.env) # 地点
dune_env_df <- 
  tibble::tibble(dune.env) |> # A1, Moisture, Management, Use, Manure
  tibble::rownames_to_column("stand") |> # 地点名を列に変換
  print(n = 8) # 8行のみ
```

<aside class="notes">
地点データとして，veganのdune.envを使用します．
行ラベルとして使われている地点名を独立した列に変換します．
</aside>

## duneデータ(組成)

```{r dune}
data(dune) # 組成
tibble(dune) |> # 0-9の値
  dplyr::select(1:5) |> # 5列のみ表示
  print(n = 8) # 8行のみ
```

<aside class="notes">
組成データとして，veganのduneを使用します．
このデータはtidyではありません．
地点のデータが列に，種のデータが行になっています．
</aside>

## duneデータの変換

```{r dune-df}
dune_df <- 
  dune |>  # 組成表形式からdf形式に変換
  ecan::table2df(st = "stand", sp = "species", ab = "cover")
dune_df
```

<aside class="notes">
tidyにするために，ecanのtable2df()を使います．
地点，種，量のデータがstand，species，coverの列になっています．
</aside>

## 種データ(ダミー)

```{r sp-dammy}
sp_dummy <- tibble::tibble(
  "species" = colnames(dune), 
  "dummy_1" = stringr::str_sub(colnames(dune), 1, 1), # 1文字目
  "dummy_6" = stringr::str_sub(colnames(dune), 6, 6)) # 6文字目
print(sp_dummy, n = 8)
```

<aside class="notes">
veganには種のデータがありません．
そこで架空の種データをでっち上げます．
種名の1文字目と6文字目を名義尺度の種データとします．
</aside>

## 結合

```{r join}
df <- 
    dune_df |>                       # 組成
    dplyr::left_join(dune_env_df) |> # 地点
    dplyr::left_join(sp_dummy)       # 種
```

<aside class="notes">
組成に地点と種のデータをそれぞれ結合します．
組成と地点は地点名(stand)で，種データとは種名(species)で結合します．
</aside>

## 結合：基本データの完成!

```{r, echo = FALSE, eval = FALSE}
  # コードの表示幅をもう少し長くできる?
```

```{r joined-show}
print(df, n = 8)
```

<aside class="notes">
</aside>

# α多様性(演習)

- s: 種数
- h: Shannon's H'
- d: Simpson's index (1 - D)
- i: Simpson's inverse (1 / D)

<aside class="notes">
</aside>

## α多様性の計算

```{r diversity}
div <- ecan::shdi(df)
print(div, n = 8)
```

<aside class="notes">
</aside>

## α多様性(地点を結合)

```{r diversity-add-st}
dune_env_df <- 
  dplyr::left_join(dune_env_df, div) # 地点を結合
```

<aside class="notes">
</aside>

## α多様性の平均値

```{r diversity-group}
dune_env_df |>
  dplyr::group_by(Management) |>
  dplyr::summarise_if(is.numeric, mean)
```


<aside class="notes">
</aside>

## α多様性の図示

```{r diversity-ggplot}
diversity_gg <- 
  dune_env_df |>
  ggplot2::ggplot(aes(x = Management, y = i)) + # 1 / d
  ggplot2::geom_boxplot(outlier.shape = NA) +  # 外れ値非表示
  ggplot2::geom_jitter(height = 0, width = 0.1) + 
  ggplot2::theme_bw() 
```

<aside class="notes">
</aside>

## α多様性の図示

```{r diversity-ggplot-show}
diversity_gg
```

<aside class="notes">
</aside>

# クラスター分析(演習)

```{r cluster}
cls <- 
  df |>
  ecan::df2table() |> # 組成形式に変換
  ecan::cluster(
    c_method = "average", # 非荷重群平均方
    d_method = "bray")    # Bray-Curtis距離
```


<aside class="notes">
</aside>

## クラスター分析の結果

```{r cluster-result}
cls
```

<aside class="notes">
</aside>

## クラスター分析結果の図示

```{r cluster-plot, eval = FALSE}
library(ggdendro)
ggdendro::ggdendrogram(cls)
```

<aside class="notes">
</aside>

## クラスター分析結果の図示

```{r cluster-plot-show, echo = FALSE}
  # echo = FALSEでコード非表示
  # include = FALSE # 実行のみで, コード・出力・図は非表示
library(ggdendro)
ggdendro::ggdendrogram(cls)
```

<aside class="notes">
</aside>

## クラスター分析(図示の準備)

```{r cluster-plot-group-prep}
indiv <- "stand"
group <- "Use"
cls_group <- ecan::cls_add_group(cls, dune_env_df, indiv = indiv, group = group)
```

<aside class="notes">
</aside>

## クラスター分析(グループ別で図示)


```{r cluster-plot-group}
ggdendro::ggdendrogram(cls_group)
```

<aside class="notes">
</aside>

## クラスター分析(グループ別で着色)

```{r cluster-plot-group-color}
cls_color <- stats::as.dendrogram(cls_group)
col <- cls_color(cls, dune_env_df, indiv = indiv, group = group)
  # dendextend::labels_colors(cls_color) <- gray(0)
```

<aside class="notes">
</aside>

## クラスター分析(グループ別で着色)

```{r cluster-plot-group-color-plot}
plot(cls_color)
dendextend::colored_bars(colors = col, cls_color, group, y_shift = 0,  y_scale = 3)
par(new = TRUE)
plot(cls_color)
```

<aside class="notes">
</aside>

## 序列化(演習)



## 序列化：nMDS

```{r nmds}
ord_nmds <- 
  df  |>
  df2table() |>
  ordination(o_method = "nmds")
```

<aside class="notes">
</aside>

## 序列化：地点の図示の準備

```{r nmds-plot-st-prep-data}
(ord_nmds_st <- ecan::ord_extract_score(ord_nmds, score = "st_scores"))
```
<aside class="notes">
</aside>

## 序列化：地点の図示

```{r nmds-plot-st-prep}
ord_nmds_st |>
  ggplot2::ggplot(aes(V1, V2, label = .data[["rowname"]])) +
  ggplot2::geom_text() +
  ggplot2::theme_bw()
```


<aside class="notes">
</aside>

## 序列化：種の図示の準備

ord_add_group()で抽出も実行

```{r nmds-plot-sp-prep}
indiv <- "species"
group <- "dummy_1"
ord_nmds_sp <- ecan::ord_add_group(ord_nmds, score = "sp_scores", df, indiv, group)
```

<aside class="notes">
</aside>

## 序列化：種の図示用のデータ

```{r nmds-plot-sp-prep-show}
ord_nmds_sp
```

<aside class="notes">
</aside>

## 序列化：種の図示

```{r nmds-plot-sp-plot}
ord_nmds_sp |>
  ggplot2::ggplot(aes(V1, V2, label = .data[[indiv]])) +
  geom_point(aes(col = .data[[group]]), alpha = 0.4, size = 7) +
  ggplot2::geom_text() +
  ggplot2::theme_bw()
```

<aside class="notes">
</aside>

# 指標種分析(演習)

`row_data = TRUE`でlabdsv::indval()のそのままの結果

```{r indval}
isa_res_raw <- ind_val(df, group = "Management", row_data = TRUE)
```

<aside class="notes">
</aside>

## 指標種分析の結果：種の出現頻度

```{r indval-raw-res-freq}
isa_res_raw$relfrq
```

<aside class="notes">
</aside>

## 指標種分析の結果：種の平均出現量

```{r indval-raw-res-abundance}
isa_res_raw$relabu
```

<aside class="notes">
</aside>

## 指標種分析の結果：指標値

```{r indval-raw-res-indval}
isa_res_raw$indval
```

<aside class="notes">
</aside>

## 指標種分析の結果：まとめ

```{r indval-raw-res-summary}
  # 最大値のクラス(区分), その指標値とp値
tibble(
  cls = isa_res_raw$maxcls, 
  ind_val = isa_res_raw$indcls, 
  p = isa_res_raw$pval)
```

<aside class="notes">
</aside>

## 指標種分析の結果：整理した結果

```{r indval-res}
group <- "Management"
(isa_res <- ind_val(df, group = group))
```

<aside class="notes">
</aside>

## 指標種分析の結果：

```{r indval-plot}
isa_res |>
   ggplot2::ggplot(aes(x = .data[[group]], y = .data[["ind.val"]],
             size = log(1 / (.data[["p.value"]] * 10)),
             label = .data[["species"]])) + 
    ggplot2::geom_point() + 
    ggrepel::geom_text_repel(aes(size = log(1 / (.data[["p.value"]] * 10), base = 5))) + 
    ggplot2::theme_bw() + 
    ggplot2::theme(legend.position = "none")
```

<aside class="notes">
</aside>

# 文献

- 原典の論文：細かな計算方法
- 書籍, 解説記事：全体的なこと

## 書籍

- 佐々木 雄大・小山 明日香・小柳 知代・古川 拓哉・内田 圭. 2015. 生物群集の構造と多様性の解析. 共立出版. 
- 小林 四郎. 1995. 生物群集の多変量解析. 蒼樹書房. 
  絶版．中古がネット書店に．
- 伊藤 秀三(編). 2003. 群落の組成と構造. 朝倉書店. 
  1977年に出版し, 絶版．2003年に復刊し, 絶版．
  中古がネット書店に．
- Wildi, Otto. 2017. Data Analysis in Vegetation Ecology, 3rd ed. Cabi.
- 鈴木時夫. 1954. 生態調査法. 古今書院. 

## 個別の解説

- Hadley, W., 2014, Tidy data. Journal of Statistical Software, 59, 1-23.
- Dufrene, M. and Legendre, P. 1997. Species assemblages and indicator species: the need for a flexible asymmetrical approach. Ecol. Monogr. 67, 345-366.
- 星野 義延. 1991. 種多様性算出のためのBraun-Blanquetの優占度階級値のパーセント被度値への変換方法. 環境科学会誌, 4, 193-205.
- Helene H. Wagner, Otto Wildi and Klaus C. Ewald. 2000. Additive partitioning of plant species diversity in an agricultural mosaic landscape. Landscape Ecology, 15. 219-227.


## 解説記事

- 加藤 和弘. 1996. 生物群集の多変量解析とその地域環境計画への応用. ランドスケープ研究, 60, 46-55.
- 大垣俊一. 1999. 群集組成の多変量解析. Argonauta, 1, 15-26.
- 大垣俊一. 2008. 多様度と類似度、分類学的新指標. Argonauta. 15, 10-22.
- 土居 秀幸・岡村 寛. 2011. 生物群集解析のための類似度とその応用: Rを使った類似度の算出, グラフ化, 検定. 日本生態学会誌, 61, 3-20. 

# Rで自動化・効率化(宣伝)

- 松村 俊和. 2025. <br>Rによる自動化・効率化レシピ集. 森北出版.
- https://github.com/matutosi/r-auto<br>(サポートページ)
- https://www.amazon.co.jp/dp/4627858310/<br>>(Amazon)
