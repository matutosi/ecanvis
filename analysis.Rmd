---
title: "植生データの解析方法"
author: "松村 俊和"
date: today()
institute: "甲南女子大学"

output:
  revealjs::revealjs_presentation:
    self_contatined: false
    theme: simple
    transition: slide
    css: style.css
---


# 植生データの解析

- 一般的な手法を解説
- 他にも色々とある
- AIに聞けば結果を教えてくれるかも
  - ブラックボックスではダメ
  - 基本的な考え方を知るのが重要

# データの取り扱い

- 種類ごとに分ける：地点，組成，種
- tidyな形式で保存
- 被度の変換

## データの種類

- 地点データ：地点，緯度，経度，標高，日時など
- 組成データ：地点，階層，種名，被度など
- 種データ：種名，科，生活型，機能型など

<aside class="notes">
地点データには，地形，天候などもある
組成データには，植物の状態(実生，開花の有無)などもある
種データには，系統関係などもある
</aside>

## tidyな形式

- 1つの変数が1つの列
- 1つの観測が1つの行
- 1つのタイプの観測群が1つの表
- 1つの値が1つのセル

## パソコンへの入力

- 1行目は項目名
- 行や列を空けない
- テキストファイル(CSV or TSV)で保存(推奨)
  - 変な変換をしない
  - 使いまわしがしやすい
- スプレッドシートで保存するとき
  - 組成，地点，種を別のシートに入力
  - 勝手に変換されないように文字列として保存


## 被度の変換

- 在・不在
- Braun-Blanquetの階級値
- 百分率
- その他もある(DAVE参照?)

```{r}
#|echo:    false
tbl <- tibble::tribble(
  ~"在・不在" , ~"B-B階級値", ~"百分率" , ~"百分率の代表値", 
  "1"         , "5"         , "75-"     , "87.5"         , 
  "1"         , "4"         , "50-"     , "62.5"         , 
  "1"         , "3"         , "25-"     , "37.5"         , 
  "1"         , "2"         , "10-"     , "17.5"         , 
  "1"         , "1"         , "1-"      ,  "5.0"         , 
  "1"         , "+"         , " -0"     , "0.1"          , 
  "1"         , "r"         , " -0"     , "0.01?"        , 
  "0"         , "-"         , "0"       , "0"            )
```

```{r}
tbl
```

<aside class="notes">
生態調査法(鈴木時夫 p61)
星野(1991)，03479.pdf参照
</aside>

# 解析の種類

- 多様性指数：α，β，γ
    - S, H', 1/d, D, Jなど
- 序列化(Ordination)：
- 分類
    - クラスター分析
    - TwinSpan
    - 分類回帰樹木
- Rarefaction Curve
- 指標種分析(IndVal or ISA：Indicator Species Analsis)

GISなどもある

## 多様性指数

- α：地点の多様性<br>
  - 1地点 / 単位面積あたりの種数
  - 均等度の考慮の有無
- β：地点間の多様性<br>
  - 地点間での類似度
  - β = γ / α
  - β = γ - α
- γ：地域の多様性

## α多様性

- 代表的な指数
  - 種数(S) [1, S]
  - Shannonの情報量(H')
  - Simpsonの均等度，1 / d：[1, S]
  - Simpsonの均等度，1 - d(D)
- 均等度：
  - S < H' < 
- 個人的見解
  - 種数は必須
  - 1/dが理解しやすい


## 類似度

- ユークリッド距離
- bray-curtis
- マンハッタン距離(碁盤の目の移動)
- correlation(相関係数)
- QS = 2a / (2a+b+c), Sorensen
- CC = a / (a+b+c), Jaccard

φ = (ad - bc) / ((a+b)(a+c)(b+d)(c+d))

<aside class="notes">
小林(1995)のp26
</aside>

## クラスター分析

- 概要
  - 地点(種)間の類似度を計算
  - 「近いもの」を結合していく
  - 類似度と結合方法の組み合わせで結果が異なる
- 結合方法は多種多様(代表的なもの)
  - 最近隣方式
  - 最遠隣方式
  - 重心方式
  - 群平均法<br>
    非加重，加重
- 個人的見解
    - 地点や種を結びつけていくイメージ
  - 1次元的
  - 非荷重群平均法が多い?

## 序列化，Ordination

- 手法は多種多様(代表的なもの)
  - PCA(主成分分析)
  - DCA
  - nMDS
  - CCA
  - RDA
- 類似度との組み合わせで結果が異なる
- 個人的見解
  - 2次元への位置づけ<br>
  本当は多次元だが，実質的には2次元だけ
  - 最近は，nMDSが多い?

# データ分析の実演

- パッケージの準備
- veganパッケージのデータ
- 前処理：かなり重要
- α多様性
- クラスター分析
- 序列化
- 指標種分析

- https://matutosi.github.io/ecan/ とほぼ同じ内容
- https://matutosi.shinyapps.io/ecanvis/ でも実行可能

## 準備：パッケージのインストール

- tidyverse: プログラムを簡単に
- vegan: 植生データ解析の定番
- ecan: 各種関数を簡単に

```{r install-packages, eval = FALSE}
  # install.packages("tidyverse")
  # install.packages("ecan")
  # install.packages("vegan") # ecanと同時にインストールされる
```

1回実行すればOK

## 準備：パッケージの呼び出し

```{r load-library}
library(vegan)
library(ecan)
library(tidyverse)
```

## dune.envデータ(地点)

```{r dune-env}
data(dune.env) # 地点
dune_env_df <- 
  dune.env |>
  tibble::tibble() |>
  tibble::rownames_to_column("stand") |> # 地点名を列に変換
  print()
```

## duneデータ(組成)

```{r dune}
data(dune) # 組成
tibble(dune) |>
  dplyr::select(1:5) # 5列のみ表示
```

- 20地点(行)，30種(列)
- 0-9の値

## duneデータの変換

```{r dune-df}
dune_df <- 
  dune |>  # 組成表形式からdf形式に変換
  ecan::table2df(st = "stand", sp = "species", ab = "cover")
dune_df
```

## 種データ(ダミー)

```{r sp-dammy}
sp_dummy <- tibble::tibble(
  "species" = colnames(dune), 
  "dummy_1" = stringr::str_sub(colnames(dune), 1, 1), # 1文字目
  "dummy_6" = stringr::str_sub(colnames(dune), 6, 6)) # 6文字目
sp_dummy
```

## データの結合

```{r join}
df <- 
    dune_df |>                       # 組成
    dplyr::left_join(dune_env_df) |> # 地点
    dplyr::left_join(sp_dummy)       # 種
```

## データの結合

```{r joined}
df
```

これで基本データか完成!

## α多様性

- s: 種数
- h: Shannon's H'
- d: Simpson's index (1 - D)
- i: Simpson's inverse (1 / D)

```{r diversity}
(div <- ecan::shdi(df))
dune_env_df <- dplyr::left_join(dune_env_df, div) # 地点データに結合
```

## α多様性の平均値

```{r diversity-group}
dune_env_df |>
  dplyr::group_by(Management) |>
  dplyr::summarise_if(is.numeric, mean)
```


## α多様性の図示

```{r diversity-ggplot}
dune_env_df |>
  ggplot2::ggplot(aes(x = Management, y = i)) + # 1 / d
  ggplot2::geom_boxplot(outlier.shape = NA) +  # 外れ値非表示
  ggplot2::geom_jitter(height = 0, width = 0.1) + 
  ggplot2::theme_bw() 
```

## クラスター分析

```{r cluster}
cls <- 
  df |>
  ecan::df2table() |> # 組成形式に変換
  ecan::cluster(c_method = "average", d_method = "bray")
cls
```

## クラスター分析結果の図示

```{r cluster-plot}
  # install.pacakges("ggdendro")
library(ggdendro)
ggdendro::ggdendrogram(cls)
```

## クラスター分析結果の図示(グループ別)

```{r cluster-plot-group}
indiv <- "stand"
group <- "Use"
cls_group <- ecan::cls_add_group(cls, dune_env_df, indiv = indiv, group = group)
ggdendro::ggdendrogram(cls_group)
```

## クラスター分析結果の図示(グループ別)

```{r cluster-plot-group-color}
indiv <- "stand"
group <- "Use"
cls_color <- 
  ecan::cls_add_group(cls, dune_env_df, indiv = indiv, group = group) |>
  stats::as.dendrogram()
col <- cls_color(cls, dune_env_df, indiv = indiv, group = group)
dendextend::labels_colors(cls_color) <- gray(0)
plot(cls_color)
dendextend::colored_bars(colors = col, cls_color, group, y_shift = 0,  y_scale = 3)
par(new = TRUE)
plot(cls)

```

## クラスター分析


```{r}
```

## クラスター分析


```{r}
```

https://matutosi.github.io/ecan/


# 文献

- 佐々木 雄大・小山 明日香・小柳 知代・古川 拓哉・内田 圭. 2015. 生物群集の構造と多様性の解析. 共立出版. 
- 伊藤 秀三(編). 2003. 群落の組成と構造. 朝倉書店. <br>
  1977年に出版し，絶版．2003年に復刊し，絶版．
  中古がネット書店に．
- 小林 四郎. 1995. 生物群集の多変量解析. 蒼樹書房. <br>
  絶版．中古がネット書店に．

- 土居 秀幸・岡村 寛. 2011. 生物群集解析のための類似度とその応用: Rを使った類似度の算出, グラフ化, 検定. 日本生態学会誌, 61, 3-20. 
- Wildi, O. 2017. Data Analysis in Vegetation Ecology, 3rd ed. Cabi.

